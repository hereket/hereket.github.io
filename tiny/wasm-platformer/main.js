document.addEventListener("DOMContentLoaded",(()=>{let e=document.getElementById("app");e.width=640,e.height=480;let t=e.getContext("2d");let n=new Map,o=new Map;async function i(e,t){return new Promise(((i,r)=>{const d=new Audio;d.preload="auto",d.addEventListener("canplaythrough",(()=>{if(n.set(e,d),o.has(e)){let t=o.get(e);s(e,t.volume,t.isLooping),o.delete(e)}i(d)})),d.addEventListener("error",(n=>{reject(new Error(`Failed to load sound: ${t}`)),a(e,volume,isLooping)})),d.src=t,d.load()}))}function a(e,t,n){o.set(e,{volume:t,isLooping:n})}function s(e,t,i){if(i&&!n.has(e))return a(e,t,i),null;if(!n.has(e))return console.log(`Sound ${e} is not loaded yet`),null;o.has(e)&&o.delete(e);const s=t/100,r=n.get(e).cloneNode();r.volume=Math.max(0,Math.min(1,s)),r.loop=i,r.play().catch((n=>{console.error("Playback failed:",n),a(e,t,i)}))}const r={Cos:Math.cos,Sin:Math.sin,Abs:Math.abs,Ceil:Math.ceil,Floor:Math.floor,LogInt:console.log,LoadAllAssets:function(){console.log("LoadAllAssets")},PlayAudio:s,UniformRandom:Math.random,GetAssets:function(e,t){new Uint8Array(c.buffer).set(d,e)},GetAssetsSize:function(){return d.length},GetPngSize:function(e,t){const n=c.buffer.slice(e,e+t),o=new DataView(n);if(2303741511!==o.getUint32(0)||218765834!==o.getUint32(4))throw new Error("Invalid PNG file signature");if(13!==o.getUint32(8))throw new Error("Invalid IHDR chunk length");if(1229472850!==o.getUint32(12))throw new Error("IHDR chunk not found at expected position");const i=o.getUint32(16),a=o.getUint32(20);o.getUint8(24),o.getUint8(25);return(65535&i)<<16|65535&a},DecompressPng:async function(e,t,n){0;const o=c.buffer.slice(t,t+n),i=new Blob([o],{type:"image/png"}),a=new Image;a.src=URL.createObjectURL(i),await a.decode();const s=document.createElement("canvas");s.width=a.width,s.height=a.height;const r=s.getContext("2d");r.drawImage(a,0,0);const d=r.getImageData(0,0,a.width,a.height);new Uint8Array(c.buffer).set(d.data,e)}};let d={},c={},u={};const l=document.createElement("canvas");l.width=320,l.height=240;const m=l.getContext("2d");async function h(){u.module;const n=u.instance;n.exports.Init(),window.requestAnimationFrame((function o(i){n.exports.DoCycle();const a=n.exports.memory.buffer,s=n.exports.GlobalPixels,r=new ImageData(new Uint8ClampedArray(a,s,307200),320);var d,c;d=e,c=r,m.putImageData(c,0,0),t.imageSmoothingEnabled=!1,t.drawImage(l,0,0,l.width,l.height,0,0,e.width,e.height),t.getImageData(0,0,d.width,d.height),window.requestAnimationFrame(o)}))}function g(e,t){w(),u.instance.exports.ProcessEventKey(e,t)}function f(e){const t=u.instance.exports.memory;return new DataView(t.buffer).getInt32(e,!0)}function w(){if(o.size>0){console.log(o.size);for(let[e,t]of o)s(e,t.volume,t.isLooping)}}document.addEventListener("click",(()=>{w()})),WebAssembly.instantiateStreaming(fetch("webgame.wasm"),{env:function(...e){return new Proxy(e,{get(t,n,o){for(let t of e)if(t.hasOwnProperty(n))return t[n];return(...e)=>{console.error("Not Implemented: "+n,e)}}})}(r)}).then((e=>{u=e;e.module;const t=e.instance;c=t.exports.memory,window.addEventListener("keydown",(function(e){g(e.keyCode,!0)})),window.addEventListener("keyup",(function(e){g(e.keyCode,!1)})),i(f(t.exports.AudioBackground.value),"music.mp3"),i(f(t.exports.AudioAmbience.value),"ambience.mp3"),i(f(t.exports.AudioDash.value),"dash.mp3"),i(f(t.exports.AudioHit.value),"hit.mp3"),i(f(t.exports.AudioJump.value),"jump.mp3"),i(f(t.exports.AudioShoot.value),"shoot.mp3"),async function(e){const t="packed.data",n=await fetch(t);n.ok||console.log(`Couldn't load ${t}`),d=await n.bytes()}().then((()=>{h()}))}));function p(e,t){e.addEventListener("mousedown",(()=>{g(t,!0)})),e.addEventListener("mouseup",(()=>{g(t,!1)})),e.addEventListener("touchstart",(()=>{g(t,!0)})),e.addEventListener("touchend",(()=>{g(t,!1)}))}p(buttonX,88),p(buttonUp,38),p(buttonLeft,37),p(buttonRight,39)}));
